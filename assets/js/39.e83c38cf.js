(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{687:function(a,s,t){"use strict";t.r(s);var e=t(52),n=Object(e.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"ansible-学习笔记"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible-学习笔记"}},[a._v("#")]),a._v(" Ansible 学习笔记")]),a._v(" "),t("p",[a._v("ansible 是一个自动化运维工具，是 python 编写的利用 ssh 连接实现的")]),a._v(" "),t("ul",[t("li",[a._v("批量控制集群")]),a._v(" "),t("li",[a._v("编写剧本自动化")])]),a._v(" "),t("h2",{attrs:{id:"ansible-入门"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible-入门"}},[a._v("#")]),a._v(" ansible 入门")]),a._v(" "),t("ol",[t("li",[a._v("master 机安装 openssh、python、ansible、sshpass，client 机安装 openssh、python")]),a._v(" "),t("li",[a._v("编辑 "),t("code",[a._v("/etc/ansible/hosts")]),a._v(" 添加 client 机 ip")]),a._v(" "),t("li",[t("code",[a._v("export ANSIBLE_HOST_KEY_CHECKING=False")]),a._v(" 关闭 know_hosts 检查")]),a._v(" "),t("li",[t("code",[a._v("ansible xxx.xxx.xxx.xxx -m ping -k")]),a._v(" 测试")])]),a._v(" "),t("h2",{attrs:{id:"ansible-架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible-架构"}},[a._v("#")]),a._v(" ansible 架构")]),a._v(" "),t("h2",{attrs:{id:"ansible-配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible-配置"}},[a._v("#")]),a._v(" ansible 配置")]),a._v(" "),t("p",[a._v("ansible 集群中的机子分为主控机 master 和客户机 client")]),a._v(" "),t("h3",{attrs:{id:"ansible-全局配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible-全局配置"}},[a._v("#")]),a._v(" ansible 全局配置")]),a._v(" "),t("p",[a._v("ansible 的配置文件在 "),t("code",[a._v("/etc/ansible/ansible.cfg")]),a._v(" 家目录下的 "),t("code",[a._v(".ansible.cfg")]),a._v(" 也会生效，常用配置项：")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("[defaults]\ninventory = /etc/ansible/hosts # 自定义清单文件路径\nhost_key_checking = False # 关闭远程主机key检查\nforks = 5 # 并发数\nlog_path = /var/log/ansible.log # 记录日志\n")])])]),t("h3",{attrs:{id:"主机清单配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主机清单配置"}},[a._v("#")]),a._v(" 主机清单配置")]),a._v(" "),t("p",[a._v("添加 client 机的 ip 到 maser 机 "),t("code",[a._v("/etc/ansible/hosts")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("[_group-name]\nxxx.xxx.xxx.xxx\nxxx.xxx.xxx.xxx\n\n[_group-name:children]\n_group-name\n_group-name\n\n[_group-name:vars]\nxxx = xxx\nxxx = xxx\n")])])]),t("blockquote",[t("p",[a._v("但是光写这些还不够，因为底层是通过 ssh 实现的，所以需要进行可信配置和免密配置")])]),a._v(" "),t("h4",{attrs:{id:"可信配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#可信配置"}},[a._v("#")]),a._v(" 可信配置")]),a._v(" "),t("p",[a._v("需要让 master 机信任 client 机，即 ssh 初次连接的 yes 机制")]),a._v(" "),t("ul",[t("li",[a._v("ssh 扫描命令 "),t("code",[a._v("ssh-keyscan xxx xxx")]),a._v(" 比较麻烦")]),a._v(" "),t("li",[a._v("使用 ansible 的 known_hosts 模块")]),a._v(" "),t("li",[a._v("修改环境变量 "),t("code",[a._v("export ANSIBLE_HOST_KEY_CHECKING=False")])]),a._v(" "),t("li",[a._v("修改 ansible 配置，去掉相关注释 "),t("code",[a._v("host_key_checking = False")])])]),a._v(" "),t("h4",{attrs:{id:"免密配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#免密配置"}},[a._v("#")]),a._v(" 免密配置")]),a._v(" "),t("p",[a._v("登陆 client 机需要密码，但总不能每次到手动输入")]),a._v(" "),t("ul",[t("li",[a._v("ssh 免密命令 "),t("code",[a._v("ssh-copy-id")])]),a._v(" "),t("li",[a._v("使用 ansible 的 authenticate_id 模块")]),a._v(" "),t("li",[a._v("在清单文件中配置 ansible_ssh_user 、 ansible_ssh_pass 和 ansible_become_pass 变量")])]),a._v(" "),t("h2",{attrs:{id:"ansible-常用模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible-常用模块"}},[a._v("#")]),a._v(" ansible 常用模块")]),a._v(" "),t("h3",{attrs:{id:"ping"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ping"}},[a._v("#")]),a._v(" ping")]),a._v(" "),t("ul",[t("li",[a._v("data 响应字符串")])]),a._v(" "),t("h3",{attrs:{id:"command"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#command"}},[a._v("#")]),a._v(" command")]),a._v(" "),t("ul",[t("li",[a._v("cmd 命令名")]),a._v(" "),t("li",[a._v("chdir 上下文路径")])]),a._v(" "),t("h3",{attrs:{id:"shell"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#shell"}},[a._v("#")]),a._v(" shell")]),a._v(" "),t("ul",[t("li",[a._v("cmd")]),a._v(" "),t("li",[a._v("chdir")])]),a._v(" "),t("h3",{attrs:{id:"copy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#copy"}},[a._v("#")]),a._v(" copy")]),a._v(" "),t("ul",[t("li",[a._v("src")]),a._v(" "),t("li",[a._v("dest")]),a._v(" "),t("li",[a._v("owner")]),a._v(" "),t("li",[a._v("group")]),a._v(" "),t("li",[a._v("mode")])]),a._v(" "),t("h3",{attrs:{id:"file"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#file"}},[a._v("#")]),a._v(" file")]),a._v(" "),t("ul",[t("li",[a._v("path")]),a._v(" "),t("li",[a._v("owner")]),a._v(" "),t("li",[a._v("group")]),a._v(" "),t("li",[a._v("mode")]),a._v(" "),t("li",[a._v("state 状态 link 表示连接")]),a._v(" "),t("li",[a._v("src 表示 link 的目标")])]),a._v(" "),t("h3",{attrs:{id:"script"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#script"}},[a._v("#")]),a._v(" script")]),a._v(" "),t("ul",[t("li",[a._v("cmd 本地脚本路径")]),a._v(" "),t("li",[a._v("chdir 远程执行上下文路径")])]),a._v(" "),t("h3",{attrs:{id:"template"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#template"}},[a._v("#")]),a._v(" template")]),a._v(" "),t("blockquote",[t("p",[a._v("使用了 python 中流行的模板引擎 Jinja2")])]),a._v(" "),t("ul",[t("li",[a._v("src j2 文件路径，默认会查找同级 templates 文件夹")]),a._v(" "),t("li",[a._v("dest")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("{% for xxx in xxxs %}\n 引用 {{ xxx }}\n{% endfor %}\n\n{% if/elif xxx is defined %}\n 引用 {{ xxx }}\n{% endif %}\n")])])]),t("h3",{attrs:{id:"user"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#user"}},[a._v("#")]),a._v(" user")]),a._v(" "),t("ul",[t("li",[a._v("user 用户名")]),a._v(" "),t("li",[a._v("state 状态 absent 表示删除用户")])]),a._v(" "),t("h3",{attrs:{id:"service"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#service"}},[a._v("#")]),a._v(" service")]),a._v(" "),t("ul",[t("li",[a._v("name 服务名")]),a._v(" "),t("li",[a._v("state 服务状态 started/stoped")])]),a._v(" "),t("h2",{attrs:{id:"ansible-playbook"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible-playbook"}},[a._v("#")]),a._v(" ansible Playbook")]),a._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("---")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" xxx\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("remote_user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" xxx\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("vars")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("_key")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" _value "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# {{ _key }} 引用")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("tasks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 任务列表")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" xxx\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("_module")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("xxx")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" xxx\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("notify")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" _handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("name\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" _handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("name\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("with_items")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# {{ item }} 引用")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" item1\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" item2\n\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("handlers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" xxx\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("...")]),a._v("\n")])])]),t("h2",{attrs:{id:"ansible-role"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible-role"}},[a._v("#")]),a._v(" ansible Role")]),a._v(" "),t("p",[a._v("采用目录组织 playbook 进行模块化编写")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("# 结构\n_playbook.yaml\nroles\n\\-- _role\n  |-- tasks\n  | |-- main.yaml # 使用import_task引入\n  | \\-- _task.yaml\n  |-- vars\n  | \\-- main.yaml\n  \\-- handlers\n    |-- main.yaml\n    \\-- _handler.yaml\n")])])]),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# playbook")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" xxx\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" xxx\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("remote_user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" xxx\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("pre_tasks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("...")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("roles")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" _role\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("post_tasks")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("...")]),a._v("\n")])])]),t("h2",{attrs:{id:"ansible-命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ansible-命令"}},[a._v("#")]),a._v(" ansible 命令")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("$ ansible-doc -l "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 显示模块列表")]),a._v("\n$ ansible-doc _module-name "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 显示模块帮助")]),a._v("\n$ ansible _group-name --list "),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 列出组清单")]),a._v("\n$ ansible _group-name/all -u xxx -k -b --become-user"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("xxx -K -m _module-name -a xxx\n$ ansible-playbook xxx.yaml\n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);