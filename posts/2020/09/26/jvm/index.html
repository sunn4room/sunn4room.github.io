<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVM 学习笔记 | sunn4room</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.62005803.css" as="style"><link rel="preload" href="/assets/js/app.2d05b873.js" as="script"><link rel="preload" href="/assets/js/9.fd2d7f08.js" as="script"><link rel="preload" href="/assets/js/3.5fc63a44.js" as="script"><link rel="preload" href="/assets/js/7.177acf7a.js" as="script"><link rel="prefetch" href="/assets/js/10.50ae4a69.js"><link rel="prefetch" href="/assets/js/11.afdccb1f.js"><link rel="prefetch" href="/assets/js/12.0010c894.js"><link rel="prefetch" href="/assets/js/13.eb55877c.js"><link rel="prefetch" href="/assets/js/14.65cfc2ff.js"><link rel="prefetch" href="/assets/js/15.0b8b74f4.js"><link rel="prefetch" href="/assets/js/16.4dbb4aa4.js"><link rel="prefetch" href="/assets/js/17.271c05bb.js"><link rel="prefetch" href="/assets/js/18.4c3e94d0.js"><link rel="prefetch" href="/assets/js/19.1a0cddca.js"><link rel="prefetch" href="/assets/js/2.d45a9055.js"><link rel="prefetch" href="/assets/js/20.cdf7cb28.js"><link rel="prefetch" href="/assets/js/21.fbf2cd3f.js"><link rel="prefetch" href="/assets/js/22.42257d5f.js"><link rel="prefetch" href="/assets/js/23.e26a383f.js"><link rel="prefetch" href="/assets/js/24.d9c833cd.js"><link rel="prefetch" href="/assets/js/25.f8ca341b.js"><link rel="prefetch" href="/assets/js/26.a42edc25.js"><link rel="prefetch" href="/assets/js/27.0127ab0c.js"><link rel="prefetch" href="/assets/js/28.cd79c0d4.js"><link rel="prefetch" href="/assets/js/29.c3f37782.js"><link rel="prefetch" href="/assets/js/30.043d284c.js"><link rel="prefetch" href="/assets/js/31.423ed3ce.js"><link rel="prefetch" href="/assets/js/32.26519eb1.js"><link rel="prefetch" href="/assets/js/33.f57167ad.js"><link rel="prefetch" href="/assets/js/34.ecaa6ee5.js"><link rel="prefetch" href="/assets/js/35.47e91ee0.js"><link rel="prefetch" href="/assets/js/36.258a624f.js"><link rel="prefetch" href="/assets/js/37.68bb6fda.js"><link rel="prefetch" href="/assets/js/38.94239711.js"><link rel="prefetch" href="/assets/js/39.e83c38cf.js"><link rel="prefetch" href="/assets/js/4.caf2fcbd.js"><link rel="prefetch" href="/assets/js/40.acf21eb1.js"><link rel="prefetch" href="/assets/js/41.d164530a.js"><link rel="prefetch" href="/assets/js/5.886701df.js"><link rel="prefetch" href="/assets/js/6.61d8e906.js"><link rel="prefetch" href="/assets/js/8.84396220.js">
    <link rel="stylesheet" href="/assets/css/0.styles.62005803.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="app"><div id="header"><img id="hero" src="/assets/img/hero.470debc7.png"><span id="title">JVM 学习笔记</span><div id="search-box" class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div><aside id="aside"><div class="__vuescroll" style="height:100%;width:100%;padding:0;position:relative;overflow:hidden;"><div class="__panel __hidebar" style="position:relative;box-sizing:border-box;height:100%;overflow-y:hidden;overflow-x:hidden;transform-origin:;transform:;"><div class="__view" style="position:relative;box-sizing:border-box;min-width:100%;min-height:100%;"><div class="margin-box"><div class="white-line"></div><div class="shell"><div class="sh-header"><div class="dot" style="background-color: #e9524a"></div><div class="dot" style="background-color: #f1ae1b"></div><div class="dot" style="background-color: #59c837"></div></div><div class="sh-body"><div class="line"><span>&gt; </span><span style="color:#4ebdcf">Who are you?</span></div><div class="line right"><span style="color:#97d209">I'm sunn4room</span><span> &lt;</span></div><div class="line right"><span style="color:#97d209">em... Just Sunny Room</span><span> &lt;</span></div><div class="line right"><span style="color:#97d209">And you?</span><span class="cursor">a</span><span> &lt;</span></div></div></div><div class="header-tag" style="font-size:1rem;font-weight:bold;margin-top:1.5rem;">JVM 学习笔记</div><a href="#运行时数据区" class="header-tag" style="font-size:1rem;margin-left:1rem;">运行时数据区</a><a href="#栈与本地方法栈" class="header-tag" style="font-size:1rem;margin-left:2rem;">栈与本地方法栈</a><a href="#执行引擎" class="header-tag" style="font-size:1rem;margin-left:1rem;">执行引擎</a><a href="#前端编译器" class="header-tag" style="font-size:1rem;margin-left:2rem;">前端编译器</a><a href="#javac" class="header-tag" style="font-size:1rem;margin-left:3rem;">javac</a><a href="#groovy" class="header-tag" style="font-size:1rem;margin-left:3rem;">groovy</a><a href="#kotlin" class="header-tag" style="font-size:1rem;margin-left:3rem;">kotlin</a><a href="#即时编译器" class="header-tag" style="font-size:1rem;margin-left:2rem;">即时编译器</a><a href="#c1-与-c2" class="header-tag" style="font-size:1rem;margin-left:3rem;">C1 与 C2</a><a href="#解释模式" class="header-tag" style="font-size:1rem;margin-left:3rem;">解释模式</a><a href="#编译模式" class="header-tag" style="font-size:1rem;margin-left:3rem;">编译模式</a><a href="#混合模式-默认" class="header-tag" style="font-size:1rem;margin-left:3rem;">混合模式（默认）</a><a href="#提前编译器" class="header-tag" style="font-size:1rem;margin-left:2rem;">提前编译器</a><a href="#graalvm" class="header-tag" style="font-size:1rem;margin-left:3rem;">graalvm</a><a href="#方法内联" class="header-tag" style="font-size:1rem;margin-left:2rem;">方法内联</a><a href="#逃逸分析" class="header-tag" style="font-size:1rem;margin-left:2rem;">逃逸分析</a><a href="#字节码" class="header-tag" style="font-size:1rem;margin-left:1rem;">字节码</a><a href="#文件结构" class="header-tag" style="font-size:1rem;margin-left:2rem;">文件结构</a><a href="#javap" class="header-tag" style="font-size:1rem;margin-left:3rem;">javap</a><a href="#类加载" class="header-tag" style="font-size:1rem;margin-left:2rem;">类加载</a><a href="#类加载时机" class="header-tag" style="font-size:1rem;margin-left:3rem;">类加载时机</a><a href="#类加载流程" class="header-tag" style="font-size:1rem;margin-left:3rem;">类加载流程</a><a href="#类加载器" class="header-tag" style="font-size:1rem;margin-left:3rem;">类加载器</a><a href="#自定义类加载器" class="header-tag" style="font-size:1rem;margin-left:4rem;">自定义类加载器</a><a href="#线程上下文类加载器" class="header-tag" style="font-size:1rem;margin-left:4rem;">线程上下文类加载器</a><a href="#javassist-框架" class="header-tag" style="font-size:1rem;margin-left:2rem;">Javassist 框架</a><a href="#cglib-框架" class="header-tag" style="font-size:1rem;margin-left:2rem;">Cglib 框架</a><a href="#asm-框架" class="header-tag" style="font-size:1rem;margin-left:2rem;">ASM 框架</a><a href="#垃圾回收" class="header-tag" style="font-size:1rem;margin-left:1rem;">垃圾回收</a><a href="#运行时数据区-2" class="header-tag" style="font-size:1rem;margin-left:2rem;">运行时数据区</a><a href="#程序计数器" class="header-tag" style="font-size:1rem;margin-left:3rem;">程序计数器</a><a href="#栈与本地方法栈-2" class="header-tag" style="font-size:1rem;margin-left:3rem;">栈与本地方法栈</a><a href="#堆" class="header-tag" style="font-size:1rem;margin-left:3rem;">堆</a><a href="#方法区" class="header-tag" style="font-size:1rem;margin-left:3rem;">方法区</a><a href="#直接内存" class="header-tag" style="font-size:1rem;margin-left:3rem;">直接内存</a><a href="#堆对象" class="header-tag" style="font-size:1rem;margin-left:2rem;">堆对象</a><a href="#垃圾标记算法" class="header-tag" style="font-size:1rem;margin-left:2rem;">垃圾标记算法</a><a href="#垃圾回收算法" class="header-tag" style="font-size:1rem;margin-left:2rem;">垃圾回收算法</a><a href="#分代垃圾回收器" class="header-tag" style="font-size:1rem;margin-left:2rem;">分代垃圾回收器</a><a href="#g1-垃圾回收器" class="header-tag" style="font-size:1rem;margin-left:2rem;">G1 垃圾回收器</a><a href="#zgc-垃圾回收器" class="header-tag" style="font-size:1rem;margin-left:2rem;">ZGC 垃圾回收器</a><a href="#gc-分析" class="header-tag" style="font-size:1rem;margin-left:2rem;">GC 分析</a><a href="#gc-日志" class="header-tag" style="font-size:1rem;margin-left:3rem;">GC 日志</a><a href="#jps" class="header-tag" style="font-size:1rem;margin-left:3rem;">jps</a><a href="#jstat" class="header-tag" style="font-size:1rem;margin-left:3rem;">jstat</a><a href="#jinfo" class="header-tag" style="font-size:1rem;margin-left:3rem;">jinfo</a><a href="#jmap" class="header-tag" style="font-size:1rem;margin-left:3rem;">jmap</a><a href="#jstack" class="header-tag" style="font-size:1rem;margin-left:3rem;">jstack</a><a href="#arthas" class="header-tag" style="font-size:1rem;margin-left:3rem;">arthas</a><a href="#基础命令" class="header-tag" style="font-size:1rem;margin-left:4rem;">基础命令</a><a href="#jvm相关" class="header-tag" style="font-size:1rem;margin-left:4rem;">jvm相关</a><a href="#class-classloader相关" class="header-tag" style="font-size:1rem;margin-left:4rem;">class/classloader相关</a><a href="#monitor-watch-trace相关" class="header-tag" style="font-size:1rem;margin-left:4rem;">monitor/watch/trace相关</a><a href="#jconsole" class="header-tag" style="font-size:1rem;margin-left:3rem;">jconsole</a><a href="#jvisualvm" class="header-tag" style="font-size:1rem;margin-left:3rem;">jvisualvm</a><a href="#并发" class="header-tag" style="font-size:1rem;margin-left:1rem;">并发</a><a href="#内存模型-jmm" class="header-tag" style="font-size:1rem;margin-left:2rem;">内存模型 JMM</a><a href="#八大基本操作" class="header-tag" style="font-size:1rem;margin-left:3rem;">八大基本操作</a><a href="#八大先行发生规则" class="header-tag" style="font-size:1rem;margin-left:3rem;">八大先行发生规则</a><a href="#volatile" class="header-tag" style="font-size:1rem;margin-left:2rem;">volatile</a><a href="#synchronized" class="header-tag endtag" style="font-size:1rem;margin-left:2rem;">synchronized</a></div></div></div></div></aside><div id="curtain"></div><main id="main"><div class="__vuescroll" style="height:100%;width:100%;padding:0;position:relative;overflow:hidden;"><div class="__panel __hidebar" style="position:relative;box-sizing:border-box;height:100%;overflow-y:hidden;overflow-x:hidden;transform-origin:;transform:;"><div class="__view" style="position:relative;box-sizing:border-box;min-width:100%;min-height:100%;"><div class="margin-box"><div class="white-line"></div><div class="box"><div class="post-tags"><span class="post-tag ca-tag"><span><a class="firstca" style="color: white">程序设计</a><span><svg aria-hidden="true" focusable="false" data-prefix="fa" data-icon="caret-right" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512" class="svg-inline--fa fa-caret-right fa-w-6" style="width:1rem;"><path fill="currentColor" d="M0 384.662V127.338c0-17.818 21.543-26.741 34.142-14.142l128.662 128.662c7.81 7.81 7.81 20.474 0 28.284L34.142 398.804C21.543 411.404 0 402.48 0 384.662z"></path></svg></span></span><span><a class="endcd" style="color: white">Java</a><!----></span></span><a class="ta-tag post-tag">java</a><a class="ta-tag post-tag">jvm</a><span class="da-tag post-tag">2020.09.26</span><!----></div></div><div class="box"><h1 style="text-align:center;">JVM 学习笔记</h1><div class="markdown-body content__default"><h1 id="jvm-学习笔记"><a href="#jvm-学习笔记" class="header-anchor">#</a> JVM 学习笔记</h1> <p>JVM（Java Virtual Machine）是对硬件模拟的软件实现，屏蔽的不同平台的差异性</p> <h2 id="运行时数据区"><a href="#运行时数据区" class="header-anchor">#</a> 运行时数据区</h2> <h3 id="栈与本地方法栈"><a href="#栈与本地方法栈" class="header-anchor">#</a> 栈与本地方法栈</h3> <p>线程栈是由栈帧构成的，如下：</p> <p><img src="/assets/img/stackele.50d3ccf4.svg" alt="stackele"></p> <ul><li><p>局部变量表：用于存放方法参数和方法内部定义的局部变量</p></li> <li><p>操作数栈：用于执行 JVM 指令时存放临时数据的</p> <blockquote><p>JVM 指令集是基于栈的，这种指令集可移植性好，但效率低，一个逻辑指令往往需要分解成多个动作。还有一种指令集是基于寄存器的，直接和硬件关联，可移植性差，但是效率高。</p></blockquote></li> <li><p>动态链接：维护在运行期间才开确定方法调用引用</p></li> <li><p>返回地址：记录方法调用时的地址，以便恢复上层执行</p></li></ul> <h2 id="执行引擎"><a href="#执行引擎" class="header-anchor">#</a> 执行引擎</h2> <h3 id="前端编译器"><a href="#前端编译器" class="header-anchor">#</a> 前端编译器</h3> <h4 id="javac"><a href="#javac" class="header-anchor">#</a> javac</h4> <h4 id="groovy"><a href="#groovy" class="header-anchor">#</a> groovy</h4> <h4 id="kotlin"><a href="#kotlin" class="header-anchor">#</a> kotlin</h4> <h3 id="即时编译器"><a href="#即时编译器" class="header-anchor">#</a> 即时编译器</h3> <h4 id="c1-与-c2"><a href="#c1-与-c2" class="header-anchor">#</a> C1 与 C2</h4> <h4 id="解释模式"><a href="#解释模式" class="header-anchor">#</a> 解释模式</h4> <h4 id="编译模式"><a href="#编译模式" class="header-anchor">#</a> 编译模式</h4> <h4 id="混合模式-默认"><a href="#混合模式-默认" class="header-anchor">#</a> 混合模式（默认）</h4> <h3 id="提前编译器"><a href="#提前编译器" class="header-anchor">#</a> 提前编译器</h3> <h4 id="graalvm"><a href="#graalvm" class="header-anchor">#</a> graalvm</h4> <h3 id="方法内联"><a href="#方法内联" class="header-anchor">#</a> 方法内联</h3> <h3 id="逃逸分析"><a href="#逃逸分析" class="header-anchor">#</a> 逃逸分析</h3> <p>在一个方法内创建的对象，根据其引用情况，会发生：</p> <ul><li>方法逃逸：作为调用参数传递到其他方法中</li> <li>线程逃逸：赋值给可以在其他线程中访问的实例变量</li></ul> <p>如果检测到一个对象不会逃逸，或者只逃逸出方法而不会逃逸出线程 ，则可能为这个对象实例采取优化：</p> <ul><li>栈上分配：因为在堆中分配对象空间会给 GC 带来压力，所以当对象不会发生线程逃逸，则没有必要分配到堆中，而是分配在栈帧中，当方法调用完毕，相应的对象的空间会被自动回收</li> <li>标量替换：当对象不会发生逃逸时，可能不会创建对象，而是分配空间给对象字段（标量），以减少对象引用访问的压力</li> <li>锁消除：当对象不会发生线程逃逸时，针对该对象的 synchronized 结构会自动删除</li></ul> <h2 id="字节码"><a href="#字节码" class="header-anchor">#</a> 字节码</h2> <p>.class 文件是一种以字节为单位的无间隔符的二进制文件，包含了 JVM 指令和其他辅助信息。JVM 规范要求 .class 文件使用强制性的语法和结构化约束，任何其他语言的实现者都可以以 .class 文件的形式将 JVM 作为语言的产品交付媒介，而 JVM 不关心 .class 的来源是什么语言。所以 JVM 保证了“平台无关性”，.class 规范保证了“语言无关性”。</p> <h3 id="文件结构"><a href="#文件结构" class="header-anchor">#</a> 文件结构</h3> <p>u1、u2、u4、u8 代表“无符号数”，info 代表“表”，即一种复合结构</p> <table><thead><tr><th>名称</th> <th>描述</th> <th>类型</th> <th>数量</th></tr></thead> <tbody><tr><td>magic</td> <td>class 文件的标识</td> <td>u4</td> <td>1</td></tr> <tr><td>minor_version</td> <td>次版本号</td> <td>u2</td> <td>1</td></tr> <tr><td>major_version</td> <td>主版本号（jdk1 -&gt; 45）</td> <td>u2</td> <td>1</td></tr> <tr><td>constant_pool_count</td> <td>常量池计数</td> <td>u2</td> <td>1</td></tr> <tr><td>constant_pool</td> <td>常量池，包含字面量和符号引用</td> <td>info</td> <td>^ - 1</td></tr> <tr><td>access_flags</td> <td>类层次的访问信息</td> <td>u2</td> <td>1</td></tr> <tr><td>this_class</td> <td>当前类索引（指向某个常量）</td> <td>u2</td> <td>1</td></tr> <tr><td>super_class</td> <td>父类索引（指向某个常量）</td> <td>u2</td> <td>1</td></tr> <tr><td>interfaces_count</td> <td>接口计数</td> <td>u2</td> <td>1</td></tr> <tr><td>interfaces</td> <td>接口索引（指向某个常量）</td> <td>u2</td> <td>^</td></tr> <tr><td>fields_count</td> <td>字段计数</td> <td>u2</td> <td>1</td></tr> <tr><td>fields</td> <td>字段信息</td> <td>info</td> <td>^</td></tr> <tr><td>methods_count</td> <td>方法计数</td> <td>u2</td> <td>1</td></tr> <tr><td>methods</td> <td>方法信息</td> <td>info</td> <td>^</td></tr> <tr><td>attributes_count</td> <td>属性表计数</td> <td>u2</td> <td>1</td></tr> <tr><td>attributes</td> <td>属性表</td> <td>info</td> <td>^</td></tr></tbody></table> <h4 id="javap"><a href="#javap" class="header-anchor">#</a> javap</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>$ javap -c
$ javap -v
</code></pre></div><h3 id="类加载"><a href="#类加载" class="header-anchor">#</a> 类加载</h3> <h4 id="类加载时机"><a href="#类加载时机" class="header-anchor">#</a> 类加载时机</h4> <ul><li>new 某类的对象</li> <li>读取某类的静态字段</li> <li>调用某类的静态方法</li> <li>反射调用某类（java.lang.reflect）</li> <li>子类触发父类的加载</li> <li>虚拟机启动时的主类加载</li> <li>方法句柄与某类相关（java.lang.invoke.MethodHandle）</li> <li>接口如果有默认方法，那么实现类会触发接口的加载</li></ul> <h4 id="类加载流程"><a href="#类加载流程" class="header-anchor">#</a> 类加载流程</h4> <img src="/assets/img/image-20200221185729842.6e79ae46.png" alt="image-20200221185729842" style="zoom:80%;"> <ul><li>加载：获取二进制字节流，生成一个代表这个类的 java.lang.Class 对象。</li> <li>验证：确保 Class 文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。</li> <li>准备：为类变量分配内存并设置类变量默认初始值，这些变量所使用的内存都将在方法区中进行分配。</li> <li>解析：虚拟机将常量池内的符号引用替换为直接引用的过程。</li> <li>初始化：执行类中定义的 Java 程序代码，包括类变量的赋初值和静态代码块。</li> <li>卸载：方法区的垃圾回收</li></ul> <h4 id="类加载器"><a href="#类加载器" class="header-anchor">#</a> 类加载器</h4> <p>上面的所有步骤都是通过类加载器来实现的，类加载器的基类为 ClassLoader。当JVM启动时会形成由三个类加载器组成的层次结构：</p> <ul><li><p>启动类加载器。</p> <ul><li>由C++实现，用户无法获得实例。</li> <li>加载JAVE_HOME\lib目录，或者-Xbootclasspath参数的路径。</li></ul></li> <li><p>扩展类加载器。</p> <ul><li>sun.misc.Launcher$ExtClassLoader实现。</li> <li>加载JAVA_HOME\lib\ext目录，或者java.ext.dirs系统变量指定的路径。</li></ul></li> <li><p>系统类加载器</p> <ul><li>sun.misc.Launcher$AppClassLoader实现。</li> <li>加载用户类路径Classpath上的类，即-classpath或java.class.path。</li></ul></li></ul> <p>类加载器实例之间存在父子关系（通过组合实现的父子关系），即子类加载器含有一个父类加载器变量，如果这个变量不为 null ，则父亲是指定的父类加载器，如果为 null ，则父亲是启动类加载器，而 Java 无法获取启动类加载器的控制权。所以暴露在外的类加载器都有父亲。加载流程如下：</p> <ol><li><p>如果显式指定了类加载器，则使用该类加载器负责加载，如<code>MyClassLoader.loadClass(&quot;xxx&quot;)</code>。如果没有指定，则使用被依赖类所使用的类加载器负责加载。</p> <blockquote><p><code>java -cp xxx -d xxx 主类名</code> ：主类所使用的类加载器就是系统类加载器</p></blockquote></li> <li><p>确定加载器之后，在缓存里查询自身是否已经加载了目标类，如果找到，则直接返回，如果没有，继续下一步</p> <blockquote><p>不同的类加载器可以加载同名类，所以需要使用类的权限定名和类加载器共同标识了内存中缓存的类。</p></blockquote></li> <li><p>自身加载时，如果该加载器有父类加载器，则委托给父类加载器加载，此时检测异常，如果加载成功，则返回，如果出现异常，继续下一步</p> <blockquote><p>父类加载器限定了子类加载器能够加载的类名称，例如任何类无法加载<code>java.lang.String</code></p></blockquote></li> <li><p>根据自身的加载方法加载目标类，如果加载成功，则返回，如果不成功，则抛出异常</p></li></ol> <blockquote><p>以上策略暗含了三种类加载机制：<strong>全盘负责</strong>、<strong>父类委托</strong>、<strong>缓存机制</strong></p></blockquote> <h5 id="自定义类加载器"><a href="#自定义类加载器" class="header-anchor">#</a> 自定义类加载器</h5> <p>需要继承 ClassLoader，API 如下：</p> <ul><li><p><code>public Class&lt;?&gt; loadClass(String name) throws ClassNotFoundException</code></p> <p>负责加载类对象</p></li> <li><p><code>protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException</code></p> <p>负责加载的实现</p></li> <li><p><code>public static ClassLoader getSystemClassLoader()</code> 获取系统类加载器</p></li> <li><p><code>public final ClassLoader getParent()</code> 获取父类加载器</p></li> <li><p>其他的一些辅助方法，如查询缓存、文件系统加载、连接等</p></li></ul> <blockquote><p>只需要重写 findClass 方法，即可自定义加载规则。但如果需要改变加载策略，可以重写 loadClass 方法，但一般不会这么做。</p></blockquote> <h5 id="线程上下文类加载器"><a href="#线程上下文类加载器" class="header-anchor">#</a> 线程上下文类加载器</h5> <blockquote><p>核心类都是由启动类加载器加载的，如果核心类代码需要引用非核心类，根据加载流程是加载不到非核心类的。为了解决这个问题，引入线程上下文类加载器，核心类可以通过线程得到设定的类加载器，从而加载非核心类。</p></blockquote> <p>线程上下文类加载器是伴随线程的一种类加载器引用，其默认引用的就是系统类加载器，可以自行设置，这种设定方便了类加载器的访问。</p> <blockquote><p>SPI 服务提供者接口机制，是一种动态加载服务提供者类的方法，底层就用到了线程上下文类加载器。</p></blockquote> <h3 id="javassist-框架"><a href="#javassist-框架" class="header-anchor">#</a> Javassist 框架</h3> <p>是一个处理字节码的框架</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ClassPool 代表一个类容器</span>
<span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 默认代表系统类空间</span>
pool<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token string">&quot;/usr/local/javalib&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加一个classpath</span>

<span class="token comment">// CtClass 代表一个抽象的Java类</span>
<span class="token class-name">CtClass</span> cc <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;xxx.xxx.Xxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 搜索一个类</span>
<span class="token class-name">CtClass</span> cc <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">&quot;xxx.xxx.Xxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建空类</span>

<span class="token comment">// 2. 新增一个字段 private String name;</span>
<span class="token comment">// 字段名为name</span>
<span class="token class-name">CtField</span> param <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtField</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.String&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> cc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 访问级别是 private</span>
param<span class="token punctuation">.</span><span class="token function">setModifiers</span><span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span>PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 初始值是 &quot;xiaoming&quot;</span>
cc<span class="token punctuation">.</span><span class="token function">addField</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> <span class="token class-name">CtField</span><span class="token punctuation">.</span><span class="token class-name">Initializer</span><span class="token punctuation">.</span><span class="token function">constant</span><span class="token punctuation">(</span><span class="token string">&quot;xiaoming&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3. 生成 getter、setter 方法</span>
cc<span class="token punctuation">.</span><span class="token function">addMethod</span><span class="token punctuation">(</span><span class="token class-name">CtNewMethod</span><span class="token punctuation">.</span><span class="token function">setter</span><span class="token punctuation">(</span><span class="token string">&quot;setName&quot;</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cc<span class="token punctuation">.</span><span class="token function">addMethod</span><span class="token punctuation">(</span><span class="token class-name">CtNewMethod</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">(</span><span class="token string">&quot;getName&quot;</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 4. 添加无参的构造函数</span>
<span class="token class-name">CtConstructor</span> cons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtConstructor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CtClass</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> cc<span class="token punctuation">)</span><span class="token punctuation">;</span>
cons<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token string">&quot;{name = \&quot;xiaohong\&quot;;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cc<span class="token punctuation">.</span><span class="token function">addConstructor</span><span class="token punctuation">(</span>cons<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 5. 添加有参的构造函数</span>
cons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtConstructor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CtClass</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.String&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> cc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// $0=this / $1,$2,$3... 代表方法参数</span>
cons<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token string">&quot;{$0.name = $1;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cc<span class="token punctuation">.</span><span class="token function">addConstructor</span><span class="token punctuation">(</span>cons<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 6. 创建一个名为printName方法，无参数，无返回值，输出name值</span>
<span class="token class-name">CtMethod</span> ctMethod <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtMethod</span><span class="token punctuation">(</span><span class="token class-name">CtClass</span><span class="token punctuation">.</span>voidType<span class="token punctuation">,</span> <span class="token string">&quot;printName&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CtClass</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> cc<span class="token punctuation">)</span><span class="token punctuation">;</span>
ctMethod<span class="token punctuation">.</span><span class="token function">setModifiers</span><span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span>PUBLIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
ctMethod<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token string">&quot;{System.out.println(name);}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctMethod<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token string">&quot;System.out.println(\&quot;起飞之前准备降落伞\&quot;);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctMethod<span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span><span class="token string">&quot;System.out.println(\&quot;成功落地。。。。\&quot;);&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cc<span class="token punctuation">.</span><span class="token function">addMethod</span><span class="token punctuation">(</span>ctMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 得到修改后的字节码数组</span>
<span class="token class-name">Class</span> c <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 得到修改后的类</span>
cc<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保存到 class 文件</span>
</code></pre></div><h3 id="cglib-框架"><a href="#cglib-框架" class="header-anchor">#</a> Cglib 框架</h3> <p>全名 Code Generate Library ，最重要的用途是通过继承的方式动态代理目标类。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span><span class="token class-name">MyClass</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
enhancer<span class="token punctuation">.</span><span class="token function">setCallbacks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span>
                                <span class="token class-name">MethodProxy</span> methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;before&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> result <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> objects<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;after&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span>
                                <span class="token class-name">MethodProxy</span> methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;before2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> result <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> objects<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;after2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
enhancer<span class="token punctuation">.</span><span class="token function">setCallbackFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CallbackFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MyClass</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MyClass</span><span class="token punctuation">)</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">doSomething2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="asm-框架"><a href="#asm-框架" class="header-anchor">#</a> ASM 框架</h3> <h2 id="垃圾回收"><a href="#垃圾回收" class="header-anchor">#</a> 垃圾回收</h2> <p>JVM 提供了各种各样的垃圾回收器，程序员不再需要关心对象的内存释放问题。</p> <h3 id="运行时数据区-2"><a href="#运行时数据区-2" class="header-anchor">#</a> 运行时数据区</h3> <img src="/assets/img/image-20200220173933099.9c3f3b25.png" alt="image-20200220173933099" style="zoom:80%;"> <h4 id="程序计数器"><a href="#程序计数器" class="header-anchor">#</a> 程序计数器</h4> <p>记录当前线程所执行的字节码的行号。</p> <ul><li>如果是执行 native 方法，则为 Undefined</li></ul> <h4 id="栈与本地方法栈-2"><a href="#栈与本地方法栈-2" class="header-anchor">#</a> 栈与本地方法栈</h4> <p>存放栈帧的位置，栈帧对应这一个方法调用。</p> <ul><li>内部维护了一个局部变量表，其大小在编译期就确定了</li> <li>会抛出 StackOverflowError</li> <li>不太可能抛出 OutOfMemoryError</li> <li>当遇到 native 方法时，会把该方法的栈帧放到本地方法栈。</li> <li>-Xss ：线程栈空间大小</li></ul> <h4 id="堆"><a href="#堆" class="header-anchor">#</a> 堆</h4> <p>存放对象实例和数组。</p> <ul><li>垃圾回收的最主要的区域，根据回收策略不同，还可以进行细分</li> <li>会抛出 OutOfMemoryError</li> <li>-Xms ：初始堆大小</li> <li>-Xmx ：堆最大</li> <li>-XX:+HeapDumpOnOutOfMemoryError</li></ul> <h4 id="方法区"><a href="#方法区" class="header-anchor">#</a> 方法区</h4> <p>存放类信息、常量池、静态变量、编译后的伪机器码等</p> <ul><li><p>很少进行垃圾回收，主要针对常量池和类卸载</p> <blockquote><p>类卸载的条件：不存在类实例、类的加载器已回收、不存在类对应的 Class 对象引用</p></blockquote></li> <li><p>会抛出 OutOfMemoryError</p></li> <li><p>-XX:MetaspaceSize(jdk8 后方法区被称为元空间)</p></li> <li><p>-XX:MaxMetaspaceSize</p></li></ul> <blockquote><p>常量池：用于编译器确定的字面量和符号引用，同时，运行时产生的常量也可以存放于此。</p></blockquote> <h4 id="直接内存"><a href="#直接内存" class="header-anchor">#</a> 直接内存</h4> <p>直接内存在 JVM 管理之外，用于避免不必要的数据复制。</p> <ul><li>堆中会产生一个对直接内存的引用</li> <li>会抛出 OutOfMemoryError</li> <li>-XX:MaxDirectMemorySize</li></ul> <h3 id="堆对象"><a href="#堆对象" class="header-anchor">#</a> 堆对象</h3> <p>如果说字节码是静态的类，那么存在堆中的就是动态的对象，而 GC 所主要关注的就是堆对象</p> <img src="data:image/png;base64,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" alt="image-20200221104210818" style="zoom:80%;"> <ul><li>对象头由 Mark Word 和 Klass Word 组成（数组还包含一个数组长度字段），包含了对象的元数据，比如数组大小、类型引用、分代年龄、锁状态等</li> <li>实例数据则是对象本身的有效信息。</li> <li>规定对象大小必须为 8 字节的整数倍，所以需要对齐填充。</li></ul> <blockquote><p>压缩指针：当内存不超过 32 G，指针依然采用 32 位大小，其中，<code>2^32=4G</code>，又因为对齐填充的 <code>2^3=8</code> ，所以可以表示多大 <code>2^35=32G</code> 的内存</p></blockquote> <blockquote><p>以 64 位操作系统为例，Mark Word 占用 8 字节，Klass Word 占用 4 字节。所以加上对齐填充，一个 new Object() 对象需要占用 16 字节。如果自定义的类有自己的字段，那么根据字段大小往上加就可以了。注意：一个引用占用 4 字节、基本类型略。</p></blockquote> <h3 id="垃圾标记算法"><a href="#垃圾标记算法" class="header-anchor">#</a> 垃圾标记算法</h3> <ul><li><p>引用计数算法：在对象中添加一个引用计数器，每当有一个地方引用它时，计数器值就加一；当引用失效时，计数器值就减一； 任何时刻计数器为零的对象就是不可能再被使用的。这种算法无法解决循环引用的问题</p></li> <li><p>可达性分析算法：从“GC Roots”出发，构建“引用链”，所有未被链接到的对象就是不可能再被使用的。Java 中的“GC Roots”通常包括栈中的引用的对象、方法区中的类静态属性引用的对象等</p> <blockquote><p><strong>三色并发标记</strong></p></blockquote></li></ul> <h3 id="垃圾回收算法"><a href="#垃圾回收算法" class="header-anchor">#</a> 垃圾回收算法</h3> <ul><li>清除：⚪🔵🔴⚪🔴🔵⚪🔵    ➤    ⚪🔵⚪⚪⚪🔵⚪🔵</li> <li>清除-整理：⚪🔵🔴⚪🔴🔵⚪🔵    ➤    🔵🔵🔵⚪⚪⚪⚪⚪</li> <li>复制-清除：【⚪🔵🔴🔵】【⚪⚪⚪⚪】    ➤    【⚪⚪⚪⚪】【🔵🔵⚪⚪】</li></ul> <h3 id="分代垃圾回收器"><a href="#分代垃圾回收器" class="header-anchor">#</a> 分代垃圾回收器</h3> <img src="data:image/png;base64,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" alt="image-20200220230353375" style="zoom:80%;"> <table><thead><tr><th>垃圾回收器</th> <th>线程</th> <th>STW</th> <th>回收算法</th> <th>说明</th></tr></thead> <tbody><tr><td>Serial</td> <td>单线程</td> <td>yes</td> <td>复制-清除</td> <td>内存消耗小</td></tr> <tr><td>ParNew</td> <td>多线程</td> <td>yes</td> <td>复制-清除</td> <td>Serial 的多线程版本</td></tr> <tr><td>Parallel Scavenge</td> <td>多线程</td> <td>yes</td> <td>复制-清除</td> <td>关注吞吐量</td></tr> <tr><td>Serial Old</td> <td>单线程</td> <td>yes</td> <td>清除-整理</td> <td>内存消耗小</td></tr> <tr><td>Parallel Old</td> <td>多线程</td> <td>yes</td> <td>清除-整理</td> <td>搭配 Parallel Scavenge</td></tr> <tr><td>CMS Old</td> <td>多线程</td> <td>no</td> <td>清除</td> <td>停顿小，浮动垃圾、空间碎片</td></tr></tbody></table> <table><thead><tr><th>命令行参数</th> <th>相关</th> <th>描述</th></tr></thead> <tbody><tr><td>-Xmn=xx</td> <td></td> <td>年轻代大小</td></tr> <tr><td>-XX:NewRatio=xx</td> <td></td> <td>年轻代与年老代的比率</td></tr> <tr><td>-XX:SurvivorRatio=xx</td> <td></td> <td>Survivor与Eden的比率</td></tr> <tr><td>-XX:MaxTenuringThreshold</td> <td></td> <td>Survivor的存活次数阈值</td></tr> <tr><td>-XX:PretenureSizeThreshold</td> <td></td> <td>直接进入年老代的对象大小阈值</td></tr> <tr><td>-XX:+UseSerialGC</td> <td>【1】</td> <td>Serial + Serial Old</td></tr> <tr><td>-XX:+UseParallelGC</td> <td>【2】</td> <td>Parallel Scavenge + Parallel Old</td></tr> <tr><td>-XX:+UseConcMarkSweepGC</td> <td>【3】</td> <td>ParNew + CMS + Serial Old(备选)</td></tr> <tr><td>-XX:ConcGCThreads=xx</td> <td>2、3</td> <td>GC 线程数</td></tr> <tr><td>-XX:GCTimeRatio=xx</td> <td>2</td> <td>设置吞吐量 1/(1+xx)</td></tr> <tr><td>-XX:+UseAdaptiveSizePolicy</td> <td>2</td> <td>激活后将动态配置细节参数</td></tr> <tr><td>-XX:CMSInitiatingOccupancyFraction=xx</td> <td>3</td> <td>设置CMS触发的老年代内存百分比</td></tr> <tr><td>-XX:+UseCMSCompactAtFullCollection</td> <td>3</td> <td>激活后Full GC会进行空间碎片清理</td></tr> <tr><td>-XX:CMSFullGCsBeforeCompaction=xx</td> <td>3</td> <td>设置多少次Full GC后，下一次Full GC进行空间碎片清理</td></tr></tbody></table> <blockquote><p>CMS 的四个阶段</p> <ul><li>初始标记：STW 后得到 GC roots</li> <li>并发标记：唤醒用户线程，并发标记可达对象</li> <li>重新标记：STW 后修复并发阶段的影响，并重新标记，确定要清除的对象</li> <li>并发清除：唤醒用户线程，并发清除垃圾对象</li></ul></blockquote> <blockquote><p>CMS 的浮动垃圾是指初始标记后，用户线程产生的新垃圾，这些垃圾不会在本次GC中得到清理。而且，当新垃圾过大，导致内存消耗殆尽，会产生Concurrent Mode Failure ，从而使用备选的 Serial Old 进行 Full GC。为了降低CMF的产生概率，可以调节 -XX:CMSInitiatingOccupancyFraction</p></blockquote> <h3 id="g1-垃圾回收器"><a href="#g1-垃圾回收器" class="header-anchor">#</a> G1 垃圾回收器</h3> <img src="data:image/png;base64,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" alt="image-20200221081906214" style="zoom:80%;"> <p>和 CMS 一样，关注的是停顿时间，不同的是，G1 可以指定期望的停顿时间，推荐80 ~ 200 ms，底层原理就是将堆进行了分域，“化整为零”，当要进行垃圾回收时，可以根据期望的停顿时间，选取最有回收价值的区域来进行垃圾回收。</p> <ul><li>初始标记：STW 后得到 GC roots</li> <li>并发标记：唤醒用户线程，并发标记可达对象</li> <li>最终标记：STW 后修复并发阶段的影响</li> <li>筛选回收：对各个区域根据回收价值进行排序，再根据期望停顿时间，选取最有价值的几个区域进行垃圾回收</li></ul> <table><thead><tr><th>命令行参数</th> <th>描述</th></tr></thead> <tbody><tr><td>-XX:+UseG1GC</td> <td>开启 G1</td></tr> <tr><td>-XX:G1HeapRegionSize=xx</td> <td>region 大小</td></tr> <tr><td>-XX:MaxGCPauseMillis=xx</td> <td>期望停顿毫秒数</td></tr></tbody></table> <blockquote><p>G1 因为分域的概念，对大内存的支持要远远优于 CMS 。</p></blockquote> <h3 id="zgc-垃圾回收器"><a href="#zgc-垃圾回收器" class="header-anchor">#</a> ZGC 垃圾回收器</h3> <p><img src="/assets/img/zgc.6a3a3976.svg" alt="zgc"></p> <p>ZGC 利用读屏障将本该停顿的时间碎片分散到了用户线程，从而达到了 GC 停顿最多 10 ms 的目标。底层原理是染色指针和内存映射，和 G1 遍历对象不同，ZGC 遍历的是指针。</p> <p>ZGC 的分域与 G1 不同：</p> <ul><li>小：2M （size&lt;256K）</li> <li>中：32M （256K&lt;=size&lt;4M）</li> <li>大：N x 2M （4M&lt;=size ，且只存一个，不会被重分配）</li></ul> <p>具体经历了一下几个阶段：</p> <p><img src="/assets/img/image-20200326162301196.4c5fbd9d.png" alt="image-20200326162301196"></p> <ul><li>Pause Mark Start阶段：是STW阶段，用来标记GC Roots直接关联到的对象；</li> <li>Concurrent Mark阶段：并发过程，从GC Roots出发，对堆上的对象做遍历进行可达性分析，ZGC的特点是这个阶段的可达性标记是在指针上，而不是在对象上进行的；</li> <li>Pause Mark End阶段：是STW阶段，用来处理上个并发阶段期间的应用变化；</li> <li>Concurrent Prepare for Relocate阶段：并发阶段，这个阶段主要用来得出本次GC过程需要清理哪些Page，将这些Page组成重分配集合。ZGC在这个阶段会扫描全堆所有的Page，用更大的扫描范围的代价换取不需要维护类似G1中Remembered Set；</li> <li>Pause Relocate Start阶段：是STW阶段，为 Concurrent Relocate 做准备；</li> <li>Concurrent Relocate阶段：并发阶段，此阶段是ZGC执行过程中的核心阶段，这个过程的主要目标是把重分配集中的存活对象复制到新的Page上，并为每个Page维护一个转发表（Forward Table）记录旧对象到新对象的转向关系，同时修改染色指针状态为“重映射状态”。得益于染色指针的使用，Page的对象被移走之后，这个Page马上就可以被释放和重用。根据染色指针的标记位得知对象所处的状态，如果此时应用访问了旧对象就可以被读内存屏障截获，然后根据转发表，将访问转发到复制的新对象上，同时更新引用值，ZGC把这个特性称为自愈（Self-Healing）；</li> <li>Concurrent Remap阶段：此阶段是并发的，此阶段主要目标是更新整个堆中指向重分配集中旧对象的所有引用。由于ZGC拥有自愈特性，所以这个阶段是个不紧急的任务，所以实现时，把这个阶段合并到下次gc的Concurrent Mark阶段了，反正都要遍历对象图，索性合并到一次遍历中。</li></ul> <table><thead><tr><th>命令行参数</th> <th>描述</th></tr></thead> <tbody><tr><td>-XX:+UseZGC</td> <td>开启 ZGC</td></tr></tbody></table> <blockquote><p>jdk15 之前还需要加上 <code>-XX:+UnlockExperimentalVMOptions</code></p></blockquote> <blockquote><p>ZGC 基本上不需要参数调优</p></blockquote> <h3 id="gc-分析"><a href="#gc-分析" class="header-anchor">#</a> GC 分析</h3> <h4 id="gc-日志"><a href="#gc-日志" class="header-anchor">#</a> GC 日志</h4> <table><thead><tr><th>参数</th> <th>描述</th></tr></thead> <tbody><tr><td>-XX:+PrintGC</td> <td>输出 GC 日志</td></tr> <tr><td>-XX:+PrintGCDetails</td> <td>输出 GC 的详细日志</td></tr> <tr><td>-XX:+PrintGCDateStamps</td> <td>输出 GC 的时间</td></tr> <tr><td>-XX:+PrintHeapAtGC</td> <td>在进行GC的前后打印出堆的信息</td></tr> <tr><td>-Xloggc:filename-%t.log</td> <td>输出到文件</td></tr> <tr><td>-XX:+UseGCLogFileRotation</td> <td>激活滚动日志</td></tr> <tr><td>-XX:GCLogFileSize=20M</td> <td>规定文件大小</td></tr> <tr><td>-XX:NumberOfGCLogFiles=5</td> <td>规定文件个数</td></tr></tbody></table> <h4 id="jps"><a href="#jps" class="header-anchor">#</a> jps</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>$ jps -l <span class="token comment"># 打印主类全限定名</span>
$ jps -v <span class="token comment"># 打印jvm参数</span>
</code></pre></div><h4 id="jstat"><a href="#jstat" class="header-anchor">#</a> jstat</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>$ jstat -gc/gcutil <span class="token operator">&lt;</span>vmid<span class="token operator">&gt;</span> <span class="token comment"># 堆内存使用情况和gc情况</span>
$ jstat -class <span class="token operator">&lt;</span>vmid<span class="token operator">&gt;</span> <span class="token comment"># 类加载卸载情况</span>
</code></pre></div><blockquote><p>详情访问：https://docs.oracle.com/en/java/javase/11/tools/jstat.html</p></blockquote> <h4 id="jinfo"><a href="#jinfo" class="header-anchor">#</a> jinfo</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>$ jinfo -flag Xxx <span class="token operator">&lt;</span>vmid<span class="token operator">&gt;</span>
$ jinfo -flag <span class="token assign-left variable">Xxx</span><span class="token operator">=</span>xx <span class="token operator">&lt;</span>vmid<span class="token operator">&gt;</span> <span class="token comment"># 仅支持运行期可修改的 flag</span>
</code></pre></div><h4 id="jmap"><a href="#jmap" class="header-anchor">#</a> jmap</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>$ jmap -histo <span class="token operator">&lt;</span>vmid<span class="token operator">&gt;</span> <span class="token comment"># 类对象数量直方图</span>
$ jmap -dump <span class="token operator">&lt;</span>vmid<span class="token operator">&gt;</span> <span class="token comment"># 堆快照</span>
</code></pre></div><h4 id="jstack"><a href="#jstack" class="header-anchor">#</a> jstack</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>$ jstack -l <span class="token operator">&lt;</span>vmid<span class="token operator">&gt;</span>
</code></pre></div><h4 id="arthas"><a href="#arthas" class="header-anchor">#</a> arthas</h4> <h5 id="基础命令"><a href="#基础命令" class="header-anchor">#</a> 基础命令</h5> <ul><li>help——查看命令帮助信息</li> <li><a href="https://arthas.aliyun.com/doc/cat.html" target="_blank" rel="noopener noreferrer">cat<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——打印文件内容，和linux里的cat命令类似</li> <li><a href="https://arthas.aliyun.com/doc/echo.html" target="_blank" rel="noopener noreferrer">echo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>–打印参数，和linux里的echo命令类似</li> <li><a href="https://arthas.aliyun.com/doc/grep.html" target="_blank" rel="noopener noreferrer">grep<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——匹配查找，和linux里的grep命令类似</li> <li><a href="https://arthas.aliyun.com/doc/tee.html" target="_blank" rel="noopener noreferrer">tee<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——复制标准输入到标准输出和指定的文件，和linux里的tee命令类似</li> <li><a href="https://arthas.aliyun.com/doc/pwd.html" target="_blank" rel="noopener noreferrer">pwd<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——返回当前的工作目录，和linux命令类似</li> <li>cls——清空当前屏幕区域</li> <li>session——查看当前会话的信息</li> <li><a href="https://arthas.aliyun.com/doc/reset.html" target="_blank" rel="noopener noreferrer">reset<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——重置增强类，将被 Arthas 增强过的类全部还原，Arthas 服务端关闭时会重置所有增强过的类</li> <li>version——输出当前目标 Java 进程所加载的 Arthas 版本号</li> <li>history——打印命令历史</li> <li>quit——退出当前 Arthas 客户端，其他 Arthas 客户端不受影响</li> <li>stop——关闭 Arthas 服务端，所有 Arthas 客户端全部退出</li> <li><a href="https://arthas.aliyun.com/doc/keymap.html" target="_blank" rel="noopener noreferrer">keymap<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——Arthas快捷键列表及自定义快捷键</li></ul> <h5 id="jvm相关"><a href="#jvm相关" class="header-anchor">#</a> jvm相关</h5> <ul><li><a href="https://arthas.aliyun.com/doc/dashboard.html" target="_blank" rel="noopener noreferrer">dashboard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——当前系统的实时数据面板</li> <li><a href="https://arthas.aliyun.com/doc/thread.html" target="_blank" rel="noopener noreferrer">thread<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——查看当前 JVM 的线程堆栈信息</li> <li><a href="https://arthas.aliyun.com/doc/jvm.html" target="_blank" rel="noopener noreferrer">jvm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——查看当前 JVM 的信息</li> <li><a href="https://arthas.aliyun.com/doc/sysprop.html" target="_blank" rel="noopener noreferrer">sysprop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——查看和修改JVM的系统属性</li> <li><a href="https://arthas.aliyun.com/doc/sysenv.html" target="_blank" rel="noopener noreferrer">sysenv<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——查看JVM的环境变量</li> <li><a href="https://arthas.aliyun.com/doc/vmoption.html" target="_blank" rel="noopener noreferrer">vmoption<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——查看和修改JVM里诊断相关的option</li> <li><a href="https://arthas.aliyun.com/doc/perfcounter.html" target="_blank" rel="noopener noreferrer">perfcounter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——查看当前 JVM 的Perf Counter信息</li> <li><a href="https://arthas.aliyun.com/doc/logger.html" target="_blank" rel="noopener noreferrer">logger<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——查看和修改logger</li> <li><a href="https://arthas.aliyun.com/doc/getstatic.html" target="_blank" rel="noopener noreferrer">getstatic<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——查看类的静态属性</li> <li><a href="https://arthas.aliyun.com/doc/ognl.html" target="_blank" rel="noopener noreferrer">ognl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——执行ognl表达式</li> <li><a href="https://arthas.aliyun.com/doc/mbean.html" target="_blank" rel="noopener noreferrer">mbean<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——查看 Mbean 的信息</li> <li><a href="https://arthas.aliyun.com/doc/heapdump.html" target="_blank" rel="noopener noreferrer">heapdump<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——dump java heap, 类似jmap命令的heap dump功能</li></ul> <h5 id="class-classloader相关"><a href="#class-classloader相关" class="header-anchor">#</a> class/classloader相关</h5> <ul><li><a href="https://arthas.aliyun.com/doc/sc.html" target="_blank" rel="noopener noreferrer">sc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——查看JVM已加载的类信息</li> <li><a href="https://arthas.aliyun.com/doc/sm.html" target="_blank" rel="noopener noreferrer">sm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——查看已加载类的方法信息</li> <li><a href="https://arthas.aliyun.com/doc/jad.html" target="_blank" rel="noopener noreferrer">jad<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——反编译指定已加载类的源码</li> <li><a href="https://arthas.aliyun.com/doc/mc.html" target="_blank" rel="noopener noreferrer">mc<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——内存编译器，内存编译<code>.java</code>文件为<code>.class</code>文件</li> <li><a href="https://arthas.aliyun.com/doc/redefine.html" target="_blank" rel="noopener noreferrer">redefine<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——加载外部的<code>.class</code>文件，redefine到JVM里</li> <li><a href="https://arthas.aliyun.com/doc/dump.html" target="_blank" rel="noopener noreferrer">dump<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——dump 已加载类的 byte code 到特定目录</li> <li><a href="https://arthas.aliyun.com/doc/classloader.html" target="_blank" rel="noopener noreferrer">classloader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——查看classloader的继承树，urls，类加载信息，使用classloader去getResource</li></ul> <h5 id="monitor-watch-trace相关"><a href="#monitor-watch-trace相关" class="header-anchor">#</a> monitor/watch/trace相关</h5> <ul><li><a href="https://arthas.aliyun.com/doc/monitor.html" target="_blank" rel="noopener noreferrer">monitor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——方法执行监控</li> <li><a href="https://arthas.aliyun.com/doc/watch.html" target="_blank" rel="noopener noreferrer">watch<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——方法执行数据观测</li> <li><a href="https://arthas.aliyun.com/doc/trace.html" target="_blank" rel="noopener noreferrer">trace<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——方法内部调用路径，并输出方法路径上的每个节点上耗时</li> <li><a href="https://arthas.aliyun.com/doc/stack.html" target="_blank" rel="noopener noreferrer">stack<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——输出当前方法被调用的调用路径</li> <li><a href="https://arthas.aliyun.com/doc/tt.html" target="_blank" rel="noopener noreferrer">tt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>——方法执行数据的时空隧道，记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测</li></ul> <h4 id="jconsole"><a href="#jconsole" class="header-anchor">#</a> jconsole</h4> <p>可视化工具</p> <h4 id="jvisualvm"><a href="#jvisualvm" class="header-anchor">#</a> jvisualvm</h4> <p>集大成者</p> <h2 id="并发"><a href="#并发" class="header-anchor">#</a> 并发</h2> <h3 id="内存模型-jmm"><a href="#内存模型-jmm" class="header-anchor">#</a> 内存模型 JMM</h3> <img src="/assets/img/image-20200222093609422-1601179229235.393aff51.png" alt="image-20200222093609422" style="zoom:80%;"> <ul><li>从 Java 内存区域的角度看，主内存对应了堆中的数据，工作内存对应了栈中的区域</li> <li>从底层硬件的角度看，主内存对应了物理内存，工作内存对应了 CPU 的高速缓存</li></ul> <h4 id="八大基本操作"><a href="#八大基本操作" class="header-anchor">#</a> 八大基本操作</h4> <img src="/assets/img/image-20200222095423041.e03ae745.png" alt="image-20200222095423041" style="zoom:80%;"> <ul><li>read 和 load 、 store 和 write ，必须成对出现，保证顺序性，不保证连续性</li> <li>assign 之后，必须保证执行 store</li> <li>不允许无原因地执行 store</li> <li>不允许工作内存自创主内存未知的变量</li> <li>获取锁的线程可以多次 lock 和 unlock</li> <li>lock 之后，将会清空工作内存中 lock 对应的变量，并重新 load 或 assign</li> <li>unlock 的前提是当前线程持有锁</li> <li>unlock 之前，必须先将工作内存中 lock 对应的变量同步会主内存，并使其他工作内存的副本失效</li> <li>read、load、use、assign、store、write 是原子性的</li> <li>lock、unlock 并没有包含在指令集中，而是提供了二个更高层次的指令 monitorentor、monitorexit，这两个指令可以实现更大范围内的原子性</li></ul> <h4 id="八大先行发生规则"><a href="#八大先行发生规则" class="header-anchor">#</a> 八大先行发生规则</h4> <p>操作A先行发生于操作 B，不是时间上的先后，而是说在发生操作B之前，操作A产生的影响能被操作B观察到，“影响”包括修改了内存中共享变量的值、 发送了消息、 调用了方法等。</p> <ul><li>在一个线程中，语义前的操作先行发生于语义后的操作</li> <li>对于一个对象，unlock 操作先行发生于后发生的 lock 操作</li> <li>对于一个 volatile 变量，写操作先行发生于后发生的读操作</li> <li>Thread 对象的 start() 方法先行发生于该线程内的所有操作</li> <li>线程内的所有操作都先行发生于该 Thread 对象的 join() 方法返回</li> <li>Thread 对象的 interrupt() 先行发生于该线程内后发生的 Thread.interrupted() 返回 true</li> <li>一个对象的初始化完成（构造函数执行结束）先行发生于它的 finalize() 方法的开始</li> <li>A 操作先行发生于 B 操作，B 操作先行发生于 C 操作，则 A 操作先行发生于 C 操作</li></ul> <h3 id="volatile"><a href="#volatile" class="header-anchor">#</a> volatile</h3> <p>JMM 对 volatile 变量有如下两个特殊要求</p> <ul><li>可见性：load 和 use 、 assign 和 store ，必须成对出现，保证顺序性，保证连续性</li> <li>有序性：store 前后分别插入 StoreStoreBarrier 和 StoreLoadBarrier，load 前后分别插入 LoadLoadBarrier 和 LoadStoreBarrier</li></ul> <blockquote><p><strong>MESI 缓存一致性协议</strong></p> <p>多个cpu从主内存读取同一个数据到各自的高速缓存，当其中某个cpu修改了缓存里的数据,该数据会马上同步回主内存，其它cpu通过总线嗅探机制可以感知到数据的变化从而将自己缓存里的数据失效。</p></blockquote> <blockquote><p><strong>指令重排序问题</strong></p> <p>程序指令交给操作系统执行时，为了某种优化的目的，会在时间线上打乱指令的执行顺序，而不会对单线程的执行结果有任何影响。但是在多线程并发的情况下，指令重排序问题就可能产生严重的影响。volatile 通过添加内存屏障有效避免了指令重排序。</p></blockquote> <blockquote><p>JMM 规定了 4 种内存屏障</p> <table><thead><tr><th style="text-align:left;">屏障类型</th> <th style="text-align:left;">指令示例</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">LoadLoad Barriers</td> <td style="text-align:left;">Load1;LoadLoad;Load2</td> <td style="text-align:left;">该屏障确保Load1数据的装载先于Load2及其后所有装载指令的的操作</td></tr> <tr><td style="text-align:left;">StoreStore Barriers</td> <td style="text-align:left;">Store1;StoreStore;Store2</td> <td style="text-align:left;">该屏障确保Store1立刻刷新数据到内存(使其对其他处理器可见)的操作先于Store2及其后所有存储指令的操作</td></tr> <tr><td style="text-align:left;">LoadStore Barriers</td> <td style="text-align:left;">Load1;LoadStore;Store2</td> <td style="text-align:left;">确保Load1的数据装载先于Store2及其后所有的存储指令刷新数据到内存的操作</td></tr> <tr><td style="text-align:left;">StoreLoad Barriers</td> <td style="text-align:left;">Store1;StoreLoad;Load2</td> <td style="text-align:left;">该屏障确保Store1立刻刷新数据到内存的操作先于Load2及其后所有装载装载指令的操作。它会使该屏障之前的所有内存访问指令(存储指令和访问指令)完成之后,才执行该屏障之后的内存访问指令</td></tr></tbody></table> <p>不同硬件架构的实现可能有所差异，以 x86 架构为例：</p> <ul><li>lfence 指令：LoadLoad</li> <li>sfence 指令：StoreStore</li> <li>mfence 指令：StoreLoad</li></ul> <p>lfence、mfence 都可以保证屏障之后的 load 操作的可见性，即会先刷新无效缓存，得到最新的修改值。</p></blockquote> <h3 id="synchronized"><a href="#synchronized" class="header-anchor">#</a> synchronized</h3> <p><img src="/assets/img/synchronized.9b8be557.svg" alt="synchronized"></p> <blockquote><p>上图中涵盖了<strong>偏向锁</strong>、<strong>轻量级锁</strong>等优化措施，除此之外：</p> <ul><li>锁消除：当检测到不可能存在锁竞争时会进行锁消除处理</li> <li>锁粗化：当检测到一段代码反复对同一个对象加锁解锁，会进行锁粗化处理</li></ul></blockquote> <blockquote><p>64 位操作系统的 Mark Word 有 64 位，与锁相关的状态如下</p> <div class="language- extra-class"><pre class="language-text"><code>no lock:         [ (25)unused | (32)hashcode | (1)unused | (4)age | 0 | 01 ]
biased lock:     [ (54)thread id  | (2)epoch | (1)unused | (4)age | 1 | 01 ]
lightweight lock:[ (62)lock record pointer                            | 00 ]
lock:            [ (62)monitor pointer                                | 10 ]
</code></pre></div></blockquote></div></div><div class="box"><div class="post-tags"><span class="post-tag ca-tag"><span><a class="firstca" style="color: white">程序设计</a><span><svg aria-hidden="true" focusable="false" data-prefix="fa" data-icon="caret-right" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 512" class="svg-inline--fa fa-caret-right fa-w-6" style="width:1rem;"><path fill="currentColor" d="M0 384.662V127.338c0-17.818 21.543-26.741 34.142-14.142l128.662 128.662c7.81 7.81 7.81 20.474 0 28.284L34.142 398.804C21.543 411.404 0 402.48 0 384.662z"></path></svg></span></span><span><a class="endcd" style="color: white">Java</a><!----></span></span><a class="ta-tag post-tag">java</a><a class="ta-tag post-tag">jvm</a><span class="da-tag post-tag">2020.09.26</span><!----></div></div><div class="box"><div id="vcomments"></div></div></div></div></div></div></main><div id="top-btn" class="btn" style="display:none;"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-up" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="svg-inline--fa fa-arrow-up fa-w-14 fa-lg"><path fill="currentColor" d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"></path></svg></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2d05b873.js" defer></script><script src="/assets/js/9.fd2d7f08.js" defer></script><script src="/assets/js/3.5fc63a44.js" defer></script><script src="/assets/js/7.177acf7a.js" defer></script>
  </body>
</html>
